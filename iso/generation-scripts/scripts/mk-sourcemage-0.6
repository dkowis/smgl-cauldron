#!/bin/sh

# Author : Benoit PAPILLAULT <benoit.papillault@free.fr>
# Creation : 26/05/2003

# Create a bootable CD-ROM from several files:
# - work/image : final system image that will be installed
# - work/iso_root : pre-image of the CDROM's root content
# 

# debug flag, either true or false
DEBUG=false

# we use $IMAGE if defined, or else work/image
if [ -z "${IMAGE}" ]; then
    IMAGE="work/image"
fi
echo "using IMAGE=${IMAGE}"

# few definitions
VERSION=2.4.23
BOOT=iso_root/boot
ISO=smgl-0.8.0-pre2-i386.iso

if ${DEBUG}; then
    echo debug mode is enabled
fi

# check directories
if [ ! -d "${IMAGE}" ]; then
    echo "${IMAGE} is missing"
    exit -1
fi

# image.tar.bz2 creation

if [ ! -f work/image.tar.bz2 ]; then
    echo "building work/image.tar.bz2..."
    if ${DEBUG}; then read ; fi

    # unmount /proc & /dev/pts (chroot is needed)
    chroot "${IMAGE}" umount /dev
    chroot "${IMAGE}" umount /proc
    
    # next line should be uncommented for REAL iso building
    (cd "${IMAGE}"; tar jcf - .) > work/image.tar.bz2
else
    echo "using existing image.tar.bz2"
    if ${DEBUG}; then read; fi
fi

# change to our working directory
cd work

if [ ! -d initrd ]; then
    echo "initrd is missing"
    exit -1
fi

if [ ! -d iso_root ] \
    || [ ! -d iso_root/isolinux ] \
    || [ ! -f iso_root/isolinux/isolinux.bin ]; then
    echo "iso_root is missing"
    exit -1
fi

cp image.tar.bz2 iso_root/ || exit -1

# initrd creation

echo "building initrd..."
if ${DEBUG}; then read ; fi

# EXT2 method
dd if=/dev/zero of=iso_root/isolinux/initrd bs=1k count=8192
mkfs -t ext2 -b 1024 -i 1024 -F iso_root/isolinux/initrd

mkdir -p mnt/initrd
mount -o loop -t ext2 iso_root/isolinux/initrd mnt/initrd
(cd initrd ; tar cfl - . ) | (cd mnt/initrd ; tar xfp - )
umount mnt/initrd

# CRAMFS method (DOES NOT WORK!)
#mkcramfs initrd iso_root/isolinux/initrd

# -f : overwrite existing initrd.gz
# -9 : do the best compression method.
gzip -f -9 iso_root/isolinux/initrd

# isolinux will try to boot /boot/linux. We cannot tell isolinux to
# boot /boot/bzImage-2.4.21 since isolinux only support 8.3 filename
# format and no symlinks. Thus, we create a symlink
# "/boot/bzImage-2.4.21 -> /boot/linux" to have the filenames we are
# used to. This is now done in mk-iso-root shell script.

# removing the rr_moved directory
rm -rf iso_root/rr_moved

echo "creating a new ISO image..."
if ${DEBUG}; then read ; fi

(cd iso_root ; mkisofs \
    -b isolinux/isolinux.bin -c isolinux/boot.cat \
    -no-emul-boot -boot-load-size 4 -boot-info-table \
    -R -o "../${ISO}" .) &&
echo "iso is under work/${ISO}" ||
exit -1

echo "writing ISO image... Press [Enter] to continue"
if ${DEBUG}; then read ; fi

# option are suited for burning a CD-RW
# -v         : verbose
# -eject     : eject the CD after burning
# blank=fast : fast blanking CD-RW before burning

modprobe ide-scsi
#cdrecord -v -eject -dev=0,0,0 -speed=8 blank=fast -data "${ISO}"

echo "Done."
