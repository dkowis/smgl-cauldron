# Menu / checklist / whatever
# If this returns 0, use result from dialog, otherwise the user cancelled
function menu_step() {
  "${DIALOG[@]}" "$@"
  rc=$?
  if [[ $rc == 0 ]] ;then # OK
    return 0
  elif [[ $rc == 1 ]] ;then # back
    return 1
  elif [[ $rc == 3 ]] ;then # abort/cancel
    exit 1
  else
    echo "Unrecognized exit code $? from dialog, bailing out" >&2
    exit 3
  fi
  return $rc
}

# Displays the doc blurb at the start of a step
# Buttons: OK, main menu, shell
# Only returns normally if the user pressed "OK", otherwise exits
function menu_docbox() {
  "${DIALOG[@]}" "$@"
  rc=$?
  if [[ $rc == 0 ]] ;then
    ((STATE++))
  elif [[ $rc == 1 ]] ;then # main menu
    exit 1
  elif [[ $rc == 3 ]] ;then # shell
    exit 2
  else
    echo "Unrecognized exit code $? from dialog, bailing out" >&2
    exit 3
  fi
}

function menu_loop() {
  STATE=initial
  while [[ $STATE != mainmenu ]] ;do
    $STATE || # Function call
    {
      echo "State $STATE failed (code $?), bailing out" >&2
      exit 3
    }
  done

  # Exit to main menu on normal completion of loop
  exit 1
}
