#!/bin/bash
#-------------------------------------------------------------------------------
##
##=head1 SYNOPSIS
##
##  liberror is a set of functions and variable definitions used
##  internally by cauldron for error handling and error definitions
##
##=head1 COPYRIGHT
##
##  Copyright 2007 by the Cauldron Team
##
##=head1 FUNCTIONS
##
##=over 4
##
#-------------------------------------------------------------------------------

#-------------------------------------------------------------------------------
# Local global variables
#-------------------------------------------------------------------------------
CDEFAULT_COLOR="\e[0m"
CBOLD="\e[1m"
CBLACK="\e[30m"
CRED="\e[31m"
CGREEN="\e[32m"
CYELLOW="\e[33m"
CBLUE="\e[34m"
CVIOLET="\e[35m"
CCYAN="\e[36m"
CWHITE="\e[37m"

CERR_COLOR="${RED}${BOLD}"
EERR_COLOR="${RED}${BOLD}"

CSPELL_COLOR="${WHITE}${BOLD}\e[40m"
CVERSION_COLOR="${WHITE}${BOLD}\e[40m"
CQUERY_COLOR="${YELLOW}${BOLD}"
CDISPEL_COLOR="${YELLOW}${BOLD}"
CCHECK_COLOR="${CYAN}"
CRESURRECT_COLOR="${GREEN}${BOLD}"
CFILE_COLOR="${GREEN}${BOLD}"
CSYMLINK_COLOR="${CYAN}${BOLD}"
CPROBLEM_COLOR="${RED}${BOLD}"
CMESSAGE_COLOR="${CYAN}"

#-------------------------------------------------------------------------------
# ERROR definitions
#-------------------------------------------------------------------------------
# cauldron errors
CERR_OK=0                 # everything is good
CERR_FATAL=1              # fatal error (missing cauldron libs, etc.)
CERR_ARCHIVE=2            # problem creating archives
CERR_CHROOT=3             # problem with a chroot
CERR_CLEANFILE=4          # missing cleaner files
CERR_TARGETSORCERY=5      # missing target sorcery files
CERR_HOSTSORCERY=6        # sorcery not installed on host

# cauldron error messages
CERR_MSG=(
          "operation succeeded"                 # CERR_OK
          "fatal error"                         # CERR_FATAL
          "sorcery not set to archive"          # CERR_ARCHIVE
          "not in chroot"                       # CERR_CHROOT
          "cleanfile not found"                 # CERR_CLEANFILE
          "could not load target sorcery"       # CERR_TARGETSORCERY
          "could not load host sorcery"         # CERR_HOSTSORCERY
          )

# enchant errors
EERR_OK=0
EERR_STEP=1

# enchant error messages
EERR_MSG=(
          "operation succeeded"                 # EERR_OK
          "step error"                          # EERR_STEP
          )

# liberror context - should be either C for cauldron or E for enchant, defaults
# to cauldron context ("C").
LIBERROR_CONTEXT=${LIBERROR_CONTEXT:-C}

#-------------------------------------------------------------------------------
# Function definitions
#-------------------------------------------------------------------------------
#-------------------------------------------------------------------------------
## @param error name (string)
##
## Checks for an error condition (via $?), and if found it will return an error
## of the specified type (arg1) if given, or of the matching type if no arg was
## given.
##
#-------------------------------------------------------------------------------
function liberror_checkerror() {
  # store the return value to preserve it
  local rc="$?"
  local error="$1"

  if [[ $rc -gt 0 ]]
  then
    if [[ -z $error || $rc -ne ${!error} ]]
    then
      error="$(liberror_geterror $rc)"
    fi
  else
    error="${LIBERROR_CONTEXT}ERR_OK"
  fi
  [[ -z $error ]] && return 1
  echo $error
  return 0
}

#-------------------------------------------------------------------------------
## @param error (int)
##
## Finds a matching error type for the given error number. This is used to get
## an error name from a raw return code, for example.
##
#-------------------------------------------------------------------------------
function liberror_geterror() {
  local error=$1

  echo $(set | grep "${LIBERROR_CONTEXT}ERR_[A-Z]*=$error" | cut -d = -f 1)
}

#-------------------------------------------------------------------------------
## @param error name (string)
##
## Prints the corresponding error message for the given error type (string,
## defined in this file, e.g. CERR_ARCHIVE) to STDOUT in the configured error
## message color.
##
#-------------------------------------------------------------------------------
function liberror_printerror() {
  local error=$1
  local errmsg=

  # check if we are in cauldron or enchant
  if [[ $LIBERROR_CONTEXT == C ]]
  then
    errmsg="${CERR_MSG[${!error}]}"
    # exit if $errmsg not defined
    [[ -z $errmsg ]] && return 1

    if [[ ${!error} -eq 0 ]]
    then
      # print a cauldron OK message
      echo "$CMESSAGE_COLOR" "$errmsg" "$CDEFAULT_COLOR"
    else
      # print a cauldron error message
      echo "$CERR_COLOR" "error: ${errmsg}!" "$CDEFAULT_COLOR"
    fi
  else
    errmsg="${EERR_MSG[${!error}]}"
    # exit if $errmsg not defined
    [[ -z $errmsg ]] && return 1

    if [[ ${!error} -eq 0 ]]
    then
      # print an enchant OK message
      echo "$EMESSAGE_COLOR" "$errmsg" "$EDEFAULT_COLOR"
    else
      # print an enchant error message
      echo "$EERR_COLOR" "error: ${errmsg}!" "$EDEFAULT_COLOR"
    fi
  fi || return 1
  return 0
}

#-------------------------------------------------------------------------------
##
## This software is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## This software is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with this software; if not, write to the Free Software
## Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
##
#-------------------------------------------------------------------------------

# vim:ai:tw=80:tabstop=2:softtabstop=2:shiftwidth=2:expandtab

